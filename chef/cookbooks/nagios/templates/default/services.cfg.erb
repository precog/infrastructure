# Nagios Service Definitions.
#
# Automatically generated by Chef.

define service {
    use                 default-service
    host_name           ^.*$
    service_description ping
    check_command       check_ping!200.0,20%!500.0,60%
}

# monitoring service checks
define service {
    service_description Nagios
    hostgroup_name      <%= node['nagios']['server_role'] %>
    check_command       check-nagios
    contact_groups      admins
    use                 default-service
}

# Uncomment if you're using Munin
#define service {
#    service_description Munin Client
#    hostgroup_name      all
#    check_command       check_tcp!4949
#    use                 default-service
#}

# default checks for all hosts
# Uncomment if you're running chef-client as a daemon
#define service {
#    service_description Chef Client
#    hostgroup_name     base
#    check_command      check_chef_client
#    use                default-service
#}

#define service {
#    service_description Free Space All Disks
#    hostgroup_name      all
#    check_command       check_all_disks
#    use                 default-service
#}
#
#define service {
#    service_description Load Average
#    hostgroup_name      all
#    check_command       check_load
#    use                 default-service
#}
#
#define service {
#    service_description Free Memory
#    hostgroup_name      all
#    check_command       check_mem
#    use                 default-service
#}

define service {
    service_description SSH
    hostgroup_name      all
    check_command       check_ssh
    use                 default-service
}

#define service {
#    service_description Processes
#    hostgroup_name      all
#    check_command       check_local_procs
#    use                 default-service
#}

<% unless @service_hosts['monitoring'].nil? -%>
# If the monitoring host is a postfix relay, uncomment this.
#define service {
#    service_description Postfix
#    hostgroup_name      monitoring
#    check_command       check_nrpe!check_smtp
#    use                 default-service
#}

# If the monitoring host is a syslog server, uncomment this.
#define service {
#    service_description Rsyslog
#    hostgroup_name      monitoring
#    check_command       check_tcp!514
#    use                 default-service
#}

<% end -%>
<% unless @service_hosts['webserver'].nil? -%>
# basic web server http check
define service {
    service_description HTTP Processes
    hostgroup_name      webserver
    check_command       check_http
    use                 default-service
}

<% end -%>
#<% unless @service_hosts['appserver'].nil? -%>
## basic check if appserver role is running unicorn
#define service {
#    service_description Unicorn Processes
#    hostgroup_name      appserver
#    check_command       check_nrpe!check_unicorn
#    use                 default-service
#}
#
#define service {
#    service_description Unicorn HTTP
#    hostgroup_name      appserver
#    check_command       check_http_port_expect!8080!"HTTP/1.1 302 Found"
#    use                 default-service
#}
#
#<% end -%>
#<% unless @service_hosts['database_master'].nil? -%>
## basic check if the database_master role is a mysql server
## database_master service checks
#define service {
#    service_description MySQL
#    hostgroup_name      database_master
#    check_command       check_nrpe!check_mysql_server
#    use                 default-service
#}
#
#<% end -%>

# Appserver checks
define service {
    use			default-service
    hostgroup_name	appserverV2
    service_description AppServer Connectivity
    check_command	check_http
}

# No longer used!
#define service {
#    use			default-service
#    hostgroup_name	appserverV2
#    service_description Analytics v0 token enum
#    check_command	check_http_content!api.reportgrid.com!30010!/tokens/?tokenId=A3BC1539-E8A9-4207-BB41-3036EC2C6E6D![
#}

define service {
    use			default-service
    hostgroup_name	appserverV2
    service_description Analytics v1 token enum
    check_command	check_http_content!api.reportgrid.com!30020!/tokens?tokenId=A3BC1539-E8A9-4207-BB41-3036EC2C6E6D![
}

define service {
    use                 default-service
    hostgroup_name      appserverV2
    service_description Analytics v1 error counts
    check_command	check_rg_service!/blueeyes/services/analytics/v1/health!errors!10!20
}

define service {
    use                 default-service
    hostgroup_name      appserverV2
    service_description Analytics v1 response times
    check_command	check_rg_service!/blueeyes/services/analytics/v1/health!response!30000!50000
}

define service {
    use                 default-service
    hostgroup_name      appserverV2
    service_description HAProxy Frontend Connections
    process_perf_data   1
    action_url          /nagiosgraph/cgi-bin/show.cgi?host=$HOSTNAME$&service=$SERVICEDESC$
    check_command        check_hastats!http!200!900
}

define service {
    use                 default-service
    hostgroup_name      appserverV2
    service_description HAProxy Analytics Connections
    process_perf_data   1
    action_url          /nagiosgraph/cgi-bin/show.cgi?host=$HOSTNAME$&service=$SERVICEDESC$
    check_command       check_hastats!services_analytics_v1!80!95
}

# devci checks
define service {
    use                 default-service
    hostgroup_name	nexus
    service_description	Nexus endpoint
    check_command	check_http_content!nexus.reportgrid.com!80!/index.html!Sonatype
}

define service {
    use                 default-service
    hostgroup_name	nexus
    service_description	Jenkins endpoint
    check_command	check_http_content_expect!devci01.reportgrid.com!8080!/securityRealm/commenceLogin!302
}

# devops checks
define service {
    use                 default-service
    hostgroup_name	monitoring
    service_description	Deployer service endpoint
    check_command	check_http_content!devops1.reportgrid.com!29999!/blueeyes/services/deployer/v1/health!service
}

# Mongo checks
define service {
    use                 default-service
    hostgroup_name          mongodb-replset-server
    service_description     Mongo Repl Connect Check
    check_command           check_mongodb!connect!27018!5!10
}

define service {
    use                 default-service
    hostgroup_name          mongodb-replset-server
    service_description     Mongo Repl Status
    check_command           check_mongodb!replset_state!27018!0!0
}

define service {
    use                 default-service
    hostgroup_name          mongodb-replset-server
    service_description     Mongo Repl Free Connections
    check_command           check_mongodb!connections!27018!70!80
}

define service {
    use                 default-service
    hostgroup_name          mongodb-replset-server
    service_description     Mongo Replication Lag
    check_command           check_mongodb!replication_lag!27018!300!900
}

define service {
    use                 default-service
    hostgroup_name          mongodb-replset-server
    service_description     Mongo Lock Percentage
    check_command           check_mongodb!lock!27018!10!20
}

define service {
    use                 default-service
    hostgroup_name          mongodb-replset-server
    service_description     Mongo Flush Average
    check_command           check_mongodb!flushing!27018!1000!2000
}

define service {
      use                     default-service
      hostgroup_name          mongodb-replset-server
      service_description     MongoDB Index Miss Ratio
      check_command           check_mongodb!index_miss_ratio!27018!.03!.06
}

# Quirrel checks
<% shard_config = [
   ["quirrel-shard", "demo1", 31150, "5CDA81E8-9817-438A-A340-F34E578E86F8", "", 1],
   ["quirrel-shard", "demo2", 31152, "5CDA81E8-9817-438A-A340-F34E578E86F8", "", 1],
   ["quirrel-shard", "demo3", 31154, "5CDA81E8-9817-438A-A340-F34E578E86F8", "", 1],
   ["quirrel-shard", "demo4", 31156, "5CDA81E8-9817-438A-A340-F34E578E86F8", "", 1],
   ["quirrel-shard", "beta", 30070, "81B2A050-7964-40B6-B9E8-AA6111F2535B", "0000000828/healthCheck/", 1], # We're using a child of the dog-food account/api key here
   ["quirrel-shard", "beta-b", 31070, "81B2A050-7964-40B6-B9E8-AA6111F2535B", "0000000828/healthCheck/", 1],
   ["quirrel-shardV2", "nebula", 30070, "AB150219-F045-4A32-A015-1C378FB1792B", "0000000067/", 1],
   ["quirrel-shardV2", "nebula-b", 30070, "AB150219-F045-4A32-A015-1C378FB1792B", "0000000067/", 1]
] # [hostgroup, name, port, token, path prefix, enable] %>

<% shard_config.each { |hostgroup,name,port,token,prefix,enabled| %>

# <%= name %> checks
define service {
       use                    default-service
       hostgroup_name         <%= hostgroup %>
       process_perf_data      1
       active_checks_enabled  <%= enabled %>
       service_description    Quirrel <%= name %> simple math query
       action_url             /nagiosgraph/cgi-bin/show.cgi?host=$HOSTNAME$&service=$SERVICEDESC$
       check_command          check_quirrel!<%= port %>!<%= token %>!"<%= name %> simple math"!"total := 2 + 1%3Btotal * 3"!1000!2000
}

define service {
       use                    default-service
       hostgroup_name         <%= hostgroup %>
       process_perf_data      1
       active_checks_enabled  <%= enabled %>
       service_description    Quirrel <%= name %> mean value query
       action_url             /nagiosgraph/cgi-bin/show.cgi?host=$HOSTNAME$&service=$SERVICEDESC$
       check_command          check_quirrel!<%= port %>!<%= token %>!"<%= name %> mean value"!"mean(load(%22/<%= prefix %>clicks%22).product.price)"!5000!10000
}

define service {
       use                    default-service
       hostgroup_name         <%= hostgroup %>
       normal_check_interval  300
       process_perf_data      1
       active_checks_enabled  <%= enabled %>
       service_description    Quirrel <%= name %> complex query
       action_url             /nagiosgraph/cgi-bin/show.cgi?host=$HOSTNAME$&service=$SERVICEDESC$
       check_command          check_quirrel!<%= port %>!<%= token %>!"<%= name %> complex"!"clicks := //<%= prefix %>clicks solve %27price, %27gender tally := count(clicks where clicks.customer.gender = %27gender & clicks.product.price = %27price) { price : %27price, gender: %27gender, tally: tally }"!40000!60000
}

<% } %>

# Blueeyes checks config [hostgroup, name, port, hostname, service/version]
# These are (currently) very simple checks against the BE health status
<% be_config = [
   ["quirrel-shard","Beta ingest",30060,"beta.precog.com","/ingest/v2"],
   ["quirrel-shard","Beta B ingest",31060,"beta.precog.com","/ingest/v2"],
   ["quirrel-shard","Beta auth",30062,"beta.precog.com","/security/v1"],
   ["quirrel-shard","Beta B auth",31062,"beta.precog.com","/security/v1"],
   ["quirrel-shard","Beta accounts",30064,"beta.precog.com","/accounts/v1"],
   ["quirrel-shard","Beta B accounts",31064,"beta.precog.com","/accounts/v1"],
   ["quirrel-shard","Beta jobs",30066,"beta.precog.com","/jobs/v1"],
   ["quirrel-shard","Beta B jobs",31066,"beta.precog.com","/jobs/v1"],

   ["quirrel-shardV2","Nebula ingest",30060,"nebula.precog.com","/ingest/v2"],
   ["quirrel-shardV2","Nebula B ingest",31060,"nebula.precog.com","/ingest/v2"],
   ["quirrel-shardV2","Nebula auth",30062,"nebula.precog.com","/security/v1"],
   ["quirrel-shardV2","Nebula B auth",31062,"nebula.precog.com","/security/v1"],
   ["quirrel-shardV2","Nebula accounts",30064,"nebula.precog.com","/accounts/v1"],
   ["quirrel-shardV2","Nebula B accounts",31064,"nebula.precog.com","/accounts/v1"],
   ["quirrel-shardV2","Nebula jobs",30066,"nebula.precog.com","/jobs/v1"],
   ["quirrel-shardV2","Nebula B jobs",31066,"nebula.precog.com","/jobs/v1"]
]
%>

<% be_config.each { |hostgroup,name,port,hostname,service| %>
define service {
    use                 default-service
    hostgroup_name      <%= hostgroup %>
    service_description <%= name %> health
    check_command	check_http_content!<%= hostname %>!<%= port %>!<%= service %>/health!uptimeSeconds
}
<% } %>

# Infrastructure tests (TODO: get service-specific plugins for HC)
<% ["quirrel-shard", "quirrel-shardV2"].each { |hostgroup| %>
define service {
    use                 default-service
    hostgroup_name      <%= hostgroup %>
    service_description Zookeeper
    check_command	check_tcp!2181
}

define service {
    use                 default-service
    hostgroup_name      <%= hostgroup %>
    service_description Kafka Local
    check_command	check_tcp!9082
}

define service {
    use                 default-service
    hostgroup_name      <%= hostgroup %>
    service_description Kafka Global
    check_command	check_tcp!9092
}

<% } %>

<% api_config = [
   ["precog_beta_api", "beta.precog.com", "81B2A050-7964-40B6-B9E8-AA6111F2535B", "0000000828"],
   ["precog_nebula_api", "nebula.precog.com", "AB150219-F045-4A32-A015-1C378FB1792B", "0000000067"]
]

api_config.each { |hostgroup,hostname,apikey,account| %>

define service {
    use                 default-service
    hostgroup_name      <%= hostgroup %>
    service_description Describe API Key
    check_command       check_https_content!<%= hostname %>!443!/security/v1/apikeys/<%= apikey %>!issuerChain
}

define service {
    use                 default-service
    hostgroup_name      <%= hostgroup %>
    service_description Describe account
    check_command       check_precog_account!<%= hostname %>!443!/accounts/v1/accounts/<%= account %>!operations@precog.com:all them rule to one!accountCreationDate
}

define service {
    use                 default-service
    hostgroup_name      <%= hostgroup %>
    service_description Simple ingest
    check_command       check_precog_account!<%= hostname %>!443!/accounts/v1/accounts/<%= account %>!operations@precog.com:all them rule to one!accountCreationDate
}



<% } %>


# Extra Nebula checks
define service {
       use                    default-service
       hostgroup_name         quirrel-shardV2
       normal_check_interval  300
       process_perf_data      1
       active_checks_enabled  1
       service_description    SnapEngage query
       action_url             /nagiosgraph/cgi-bin/show.cgi?host=$HOSTNAME$&service=$SERVICEDESC$
       check_command          check_quirrel!30070!C0F57A14-2931-4BEF-8ABF-B6E239A2FD59!"SnapEngage query"!"import std::stats::* import std::time::* agents := //0000000056/se12014/timzon-snapabug-widget/status upperBound := 1358261667962 lowerBound := 1357023600000 extraLB := lowerBound - (24*60*60000) results := solve 'agent agents' := agents where agents.timestamp <= upperBound & agents.timestamp >= extraLB & agents.agentId = 'agent order := denseRank(agents'.timestamp) agents'' := agents' with { rank: order } newagents := new agents'' newagents' := newagents with { rank: newagents.rank - 1 } result := newagents' ~ agents'' { first: agents'', second: newagents' } where newagents'.rank = agents''.rank {start: std::math::max(result.first.timestamp, lowerBound), end: result.second.timestamp, agentId: result.first.agentId, status: result.first.status, name: result.first.agentAlias, data: result.first} results where results.end > lowerBound"!10000!15000
}

# HAProxy checks for V2 services

<% %w{quirrel-shard quirrel-shardV2}.each{ |hostgroup| %>
define service {
    use                 default-service
    hostgroup_name      <%= hostgroup %>
    service_description HAProxy
    process_perf_data   1
    action_url          /nagiosgraph/cgi-bin/show.cgi?host=$HOSTNAME$&service=$SERVICEDESC$
    check_command       check_haproxy!/haproxy/stats
}

define service {
    use                 default-service
    hostgroup_name      <%= hostgroup %>
    service_description HAProxy Frontend Connections
    process_perf_data   1
    action_url          /nagiosgraph/cgi-bin/show.cgi?host=$HOSTNAME$&service=$SERVICEDESC$
    check_command       check_hastats!http!200!900
}

<% %w{security accounts jobs ingest query}.each{ |service| %>
define service {
    use                 default-service
    hostgroup_name      <%= hostgroup %>
    service_description HAProxy <%= service %> Connections
    process_perf_data   1
    action_url          /nagiosgraph/cgi-bin/show.cgi?host=$HOSTNAME$&service=$SERVICEDESC$
    check_command       check_hastats!service_<%= service %>!80!95
}
<% } %>
<% } %>
 
define service {
    use                 default-service
    hostgroup_name      quirrel-shard
    service_description HAProxy Demo Connections
    process_perf_data   1
    action_url          /nagiosgraph/cgi-bin/show.cgi?host=$HOSTNAME$&service=$SERVICEDESC$
    check_command       check_hastats!demo_quirrel!80!95
}


# Quirrel shard additional services
define service {
       use                 default-service
       hostgroup_name      quirrel-shard
       service_description qwebirc
       check_command       check_https_content!api.precog.com!9090!/!Quirrel
}

# API content checks
define service {
    use                 default-service
    hostgroup_name      reportgrid_api
    service_description Precog JS
    check_command       check_http_content!api.reportgrid.com!80!/js/precog.js!Precog
}

define service {
    use                 default-service
    hostgroup_name      reportgrid_api
    service_description Reportgrid Core JS
    check_command       check_http_content!api.reportgrid.com!80!/js/reportgrid-core.js!ReportGrid
}

define service {
    use                 default-service
    hostgroup_name      reportgrid_api
    service_description Reportgrid Core CSS
    check_command       check_http_content!api.reportgrid.com!80!/css/rg.css!rg-colors-default
}

define service {
    use                 default-service
    hostgroup_name      reportgrid_api
    service_description Reportgrid Query JS
    check_command       check_http_content!api.reportgrid.com!80!/js/reportgrid-query.js!function
}

define service {
    use                 default-service
    hostgroup_name      reportgrid_api
    service_description Reportgrid Viz JS
    check_command       check_http_content!api.reportgrid.com!80!/js/reportgrid-viz.js!function
}

define service {
    use                 default-service
    hostgroup_name      reportgrid_api
    service_description Reportgrid Charts JS
    check_command       check_http_content!api.reportgrid.com!80!/js/reportgrid-charts.js!function
}

define service {
    use                 default-service
    hostgroup_name      reportgrid_api
    service_description Reportgrid Charts CSS
    check_command       check_http_content!api.reportgrid.com!80!/css/rg-charts.css!rg-colors-charts
}

define service {
    use                 default-service
    hostgroup_name      reportgrid_api
    service_description Reportgrid Viz Samples
    check_command       check_http_content!api.reportgrid.com!80!/services/viz/samples/index.php!overlapping
}

# Monitor the web servers
define service {
    use                 default-service
    hostgroup_name      precogstaticsite
    service_description Precog Website HTTP
    check_command       check_http
}

define service {
    use                 default-service
    hostgroup_name      precogstaticsite
    service_description Precog Website
    check_command       check_https_content!www.precog.com!443!/!Precog
}
