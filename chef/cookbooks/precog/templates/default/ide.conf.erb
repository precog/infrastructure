<% @params[:server_aliases] ||= [] %>
<VirtualHost *:20000>
  ServerName <%= @params[:server_name] %>
  ServerAlias <% @params[:server_aliases].each do |a| %><%= "#{a}" %> <% end %>
  DocumentRoot <%= @params[:docroot] %>
  RewriteEngine On
  
  <Directory <%= @params[:docroot] %>>
    Options FollowSymLinks
    AllowOverride Limit FileInfo
    Order allow,deny
    Allow from all

    Header set Access-Control-Allow-Origin *
    Header set Access-Control-Allow-Headers "Origin, X-Requested-With, Content-Type, X-File-Name, X-File-Size, X-File-Type, X-Precog-Path, X-Precog-Service, X-Precog-Token, X-Precog-Uuid, Accept"
    Header set Access-Control-Allow-Methods GET
    Header append Access-Control-Allow-Methods HEAD
    Header append Access-Control-Allow-Methods POST
    Header append Access-Control-Allow-Methods OPTIONS
    Header append Access-Control-Allow-Methods TRACE
    Header append Access-Control-Allow-Methods PUT
    Header append Access-Control-Allow-Methods DELETE
  </Directory>

  # Make legacy URLs work still
  Alias /ide <%= @params[:docroot] %>
  
  <Directory />
    Options FollowSymLinks
    AllowOverride None
  </Directory>

  <Location /server-status>
    SetHandler server-status

    Order Deny,Allow
    Deny from all
    Allow from 127.0.0.1
  </Location>

  LogLevel info
  ErrorLog <%= node[:apache][:log_dir] %>/<%= @params[:name] %>-error.log
  CustomLog <%= node[:apache][:log_dir] %>/<%= @params[:name] %>-access.log combined

  RewriteEngine On
  RewriteLog <%= node[:apache][:log_dir] %>/<%= @application_name %>-rewrite.log
  RewriteLogLevel 0

  RewriteCond %{HTTP_HOST} ^devide.precog.com$ [OR]
  RewriteCond %{HTTP_HOST} ^devlab.precog.com$
  RewriteRule ^/(.*)$        https://devlabcoat.precog.com/$1 [L,R=301]

  RewriteCond %{HTTP_HOST} ^ide.precog.com$ [OR]
  RewriteCond %{HTTP_HOST} ^lab.precog.com$
  RewriteRule ^/(.*)$        https://labcoat.precog.com/$1 [L,R=301]

#  RewriteLog <%= node[:apache][:log_dir] %>/<%= @application_name %>-rewrite.log
#  RewriteLogLevel 0
#
#  # Canonical host, <%= @params[:server_name] %>
#  RewriteCond %{HTTP_HOST}   !^<%= @params[:server_name] %> [NC]
#  RewriteCond %{HTTP_HOST}   !^$
#  RewriteRule ^/(.*)$        http://<%= @params[:server_name] %>/$1 [L,R=301]
#
#  RewriteCond %{DOCUMENT_ROOT}/system/maintenance.html -f
#  RewriteCond %{SCRIPT_FILENAME} !maintenance.html
#  RewriteRule ^.*$ /system/maintenance.html [L]
</VirtualHost>
