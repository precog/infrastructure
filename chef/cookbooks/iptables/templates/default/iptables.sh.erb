#!/bin/bash

/sbin/iptables -F INPUT

/sbin/iptables -F RGSERVERS
/sbin/iptables -X RGSERVERS
/sbin/iptables -N RGSERVERS

# Allow all loopback
/sbin/iptables -A INPUT -i lo -j ACCEPT

# Allow other RG servers
<% @rgservers.each do |n| %>
/sbin/iptables -A RGSERVERS -s <%= if n[:cloud] then n[:cloud][:public_ipv4] else n[:ipaddress] end %> -j ACCEPT
<% end %>

# No one else!
/sbin/iptables -A RGSERVERS -j REJECT

/sbin/iptables -A INPUT -p tcp --dport 27017:27019 -j RGSERVERS
/sbin/iptables -A INPUT -p tcp --dport 28017:28019 -j RGSERVERS