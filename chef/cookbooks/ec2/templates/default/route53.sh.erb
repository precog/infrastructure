#!/bin/bash
#
# This script updates the public DNS records for this host
#

<% 
# Need to handle different installation locations (to support older LTS)
if FileTest.exists? "/usr/bin/route53" then
  route53bin = "/usr/bin/route53"
elsif FileTest.exists? "/var/lib/gems/1.8/bin/route53" then
  route53bin = "/var/lib/gems/1.8/bin/route53"
end
%>


# Handle the primary names
if <%= route53bin %> -l reportgrid.com. | grep `hostname` | grep -v <%= node[:cloud][:public_hostname] %>; then
    <%= "#{route53bin} --file /root/.route53 --zone reportgrid.com. --remove --name #{node[:fqdn] + '.'} --type CNAME | tee -a #{node[:ec2][:route53][:log]}" %>

    <%= "#{route53bin} --file /root/.route53 --zone reportgrid.com. --create --name #{node[:fqdn] + '.'} --type CNAME --ttl 60 --values #{node[:cloud][:public_hostname] + '.'} | tee -a #{node[:ec2][:route53][:log]} " %>
fi


<% node[:ec2][:route53][:aliases].each do |dnsalias| %>
# Handle alias <%= dnsalias %>
if <%= route53bin %> -l reportgrid.com. | grep dnsalias | grep -v <%= node[:cloud][:public_hostname] %>; then
    <%= "#{route53bin} --file /root/.route53 --zone reportgrid.com. --remove --name #{dnsalias + '.'} --type CNAME | tee -a #{node[:ec2][:route53][:log]}"  %>
    <%= "#{route53bin} --file /root/.route53 --zone reportgrid.com. --create --name #{dnsalias + '.'} --type CNAME --ttl 60 --values #{node[:cloud][:public_hostname] + '.'} | tee -a #{node[:ec2][:route53][:log]} " %>
fi
<% end %>

